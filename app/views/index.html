<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <title>Расчет стоимости аренды</title>
</head>
<body>
    <h1>Калькулятор аренды квартиры</h1>

    <form id="rentalForm" onsubmit="calculateRentalPrice(event)">
        <!-- Основные параметры -->
        <div class="form-group">
            <h3 class="section-title">Основные параметры</h3>
            <div class="input-group">
                <label for="totalArea">Общая площадь (м²):</label>
                <input type="number" step="0.01" id="totalArea" name="totalArea" required>
            </div>
            <div class="input-group">
                <label for="livingArea">Жилая площадь (м²):</label>
                <input type="number" step="0.01" id="livingArea" name="livingArea" required>
            </div>
            <div class="input-group">
                <label for="kitchenArea">Площадь кухни (м²):</label>
                <input type="number" step="0.01" id="kitchenArea" name="kitchenArea" required>
            </div>
        </div>

        <!-- Тип жилья -->
        <div class="form-group">
            <h3 class="section-title">Тип жилья</h3>
            <div class="input-group">
                <label for="flatType">Тип:</label>
                <select id="flatType" name="flatType" onchange="updateRoomCountVisibility()" required>
                    <option value="flat">Квартира</option>
                    <option value="studio">Студия</option>
                    <option value="apartments">Апартаменты</option>
                </select>
            </div>
            <div class="input-group" id="roomsCountDiv">
                <label for="roomsCount">Количество комнат:</label>
                <input type="number" id="roomsCount" name="roomsCount" required>
            </div>
        </div>

        <!-- Характеристики здания -->
        <div class="form-group">
            <h3 class="section-title">Характеристики здания</h3>
            <div class="input-group">
                <label for="floors_count">Этажей в доме:</label>
                <input type="number" id="floors_count" name="floors_count" required>
            </div>
            <div class="input-group">
                <label for="floorNumber">Этаж квартиры:</label>
                <input type="number" id="floorNumber" name="floorNumber" required>
            </div>
            <div class="input-group">
                <label for="building_material">Материал стен:</label>
                <select id="building_material" name="building_material" required>
                    <option value="old">Старый фонд</option>
                    <option value="brick">Кирпич</option>
                    <option value="monolith">Монолит</option>
                    <option value="monolithBrick">Монолит+Кирпич</option>
                    <option value="panel">Панель</option>
                    <option value="block">Блоки</option>
                    <option value="other">Другое</option>
                </select>
            </div>
        </div>

        <!-- Дополнительные параметры -->
        <div class="form-group">
            <h3 class="section-title">Дополнительно</h3>
            <div class="input-group">
                <label for="elevators">Количество лифтов:</label>
                <input type="number" id="elevators" name="elevators" required>
            </div>
            <div class="input-group">
                <label for="balconiesCount">Балконы:</label>
                <input type="number" id="balconiesCount" name="balconiesCount" required>
            </div>
            <div class="checkbox-group">
                <label for="has_underground_parking">Подземная парковка:</label>
                <input type="checkbox" id="has_underground_parking" name="has_underground_parking">
            </div>
            <div class="checkbox-group">
                <label for="hasFurniture">Мебель:</label>
                <input type="checkbox" id="hasFurniture" name="hasFurniture">
            </div>
            <div class="checkbox-group">
                <label for="isPremium">Премиум:</label>
                <input type="checkbox" id="isPremium" name="isPremium">
            </div>
        </div>

        <!-- Адрес -->
        <div class="form-group">
            <h3 class="section-title">Расположение</h3>
            <div class="input-group">
                <label for="address">Адрес:</label>
                <input type="text" id="address" name="address" required>
                <div id="suggestions" class="suggestions-dropdown"></div>
            </div>
        </div>

        <button type="submit">Рассчитать стоимость</button>
    </form>

    <div id="errors"></div>
    <div id="result"></div>
    <script>
        async function calculateRentalPrice(event) {
            event.preventDefault();
            const resultContainer = document.getElementById("result");
            resultContainer.innerHTML = "";
            const errorContainer = document.getElementById("errors");
            errorContainer.innerHTML = "";

            const formData = new FormData(event.target);
            const data = Object.fromEntries(formData.entries());

            data["has_underground_parking"] = formData.get("has_underground_parking") === "on";
            data["hasFurniture"] = formData.get("hasFurniture") === "on";
            data["isPremium"] = formData.get("isPremium") === "on";

            if (data.flatType === "studio") {
                data.roomsCount = 0;
            }

            // Отправляем данные на сервер
            try {
                const response = await fetch("/api/get_price", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                });

                if (response.ok) {
                    const result = await response.json();
                    resultContainer.innerHTML = `
                        <h3>Результат:</h3>
                        <p>Примерная стоимость аренды: <strong>${result.total_price}</strong></p>
                    `;
                } else {
                    const errorData = await response.json();
                    if (errorData.errors) {
                        errorContainer.innerHTML = `
                            <h3>Ошибки:</h3>
                            <ul>
                                ${errorData.errors
                                    .map(
                                        (error) =>
                                            `<li>${error}</li>`
                                    )
                                    .join("")}
                            </ul>
                        `;
                    } else {
                        errorContainer.innerHTML = `<p>Произошла ошибка: ${errorData.errors}</p>`;
                    }
                }
            } catch (error) {
                errorContainer.innerHTML = `<p>Произошла непредвиденная ошибка: ${error.message}</p>`;
            }
        }

        function updateRoomCountVisibility() {
            const flatType = document.getElementById("flatType").value;
            const roomsCountDiv = document.getElementById("roomsCountDiv");
            const roomsCountInput = document.getElementById("roomsCount");

            if (flatType === "studio") {
                roomsCountDiv.style.display = "none";
                roomsCountInput.value = "0";
            } else {
                roomsCountDiv.style.display = "block";
            }
        }

        const input = document.getElementById('address');
        const dropdown = document.getElementById('suggestions');
        let currentFocus = -1;
        let timeoutId;

        // Обработчик ввода
        input.addEventListener('input', function(e) {
            clearTimeout(timeoutId);
            const query = e.target.value.trim();

            if (query.length < 3) {
                closeDropdown();
                return;
            }

            timeoutId = setTimeout(() => fetchSuggestions(query), 300);
        });

        // Обработчик клавиатуры
        input.addEventListener('keydown', function(e) {
            const items = dropdown.getElementsByClassName('suggestion-item');

            if (items.length === 0) return;

            switch(e.key) {
                case 'ArrowDown':
                    e.preventDefault();
                    currentFocus = Math.min(currentFocus + 1, items.length - 1);
                    highlightItem(items[currentFocus]);
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    currentFocus = Math.max(currentFocus - 1, -1);
                    highlightItem(currentFocus >= 0 ? items[currentFocus] : null);
                    break;
                case 'Enter':
                    e.preventDefault();
                    if (currentFocus > -1) {
                        items[currentFocus].click();
                    }
                    break;
                case 'Escape':
                    closeDropdown();
                    break;
            }
        });

        // Запрос к бэкенду
        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`/api/address?query=${encodeURIComponent(query)}`);
                const suggestions = await response.json();
                showSuggestions(suggestions);
            } catch (error) {
                console.error('Ошибка:', error);
                closeDropdown();
            }
        }

        // Отображение подсказок
        function showSuggestions(suggestions) {
            dropdown.innerHTML = suggestions
                .map((s, index) => `
                    <div class="suggestion-item"
                         data-index="${index}"
                         onclick="selectSuggestion(this)">${s}</div>
                `).join('');

            dropdown.style.display = 'block';
            currentFocus = -1;
        }

        // Выбор подсказки
        function selectSuggestion(element) {
            input.value = element.textContent;
            closeDropdown();
        }

        // Подсветка элемента
        function highlightItem(element) {
            Array.from(dropdown.children).forEach(child => {
                child.style.backgroundColor = '';
            });

            if (element) {
                element.style.backgroundColor = '#f8f9fa';
                element.scrollIntoView({ block: 'nearest' });
            }
        }

        // Закрытие списка
        function closeDropdown() {
            dropdown.style.display = 'none';
            currentFocus = -1;
        }

        // Закрытие при клике вне области
        document.addEventListener('click', function(e) {
            if (!input.contains(e.target) && !dropdown.contains(e.target)) {
                closeDropdown();
            }
        });
    </script>
</body>
</html>